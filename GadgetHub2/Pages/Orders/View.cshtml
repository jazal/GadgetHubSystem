@page "{OrderId:int}"

@model GadgetHub.Web.Pages.Orders.ViewModel

@using GadgetHub.Dtos.Distributors
@using GadgetHub.Dtos.Quotations
@using GadgetHub.Web.Pages.Orders

@{
    var distributorId = 2;
    var quotations = ViewData["quotations"] as List<QuotationsViewModel>;
}

<h2>Order Details - #@Model.OrderId</h2>

@if (Model.Order != null)
{
    <div class="order-details-container">
        <table class="table table-bordered order-table">
            <tbody>
                <tr>
                    <td class="fw-bold">Customer</td>
                    <td>@Model.Order.CustomerName</td>
                </tr>
                <tr>
                    <td class="fw-bold">Email</td>
                    <td>@Model.Order.CustomerEmail</td>
                </tr>
                <tr>
                    <td class="fw-bold">Order Date</td>
                    <td>@Model.Order.CreatedOn?.ToShortDateString()</td>
                </tr>
                <tr>
                    <td class="fw-bold">Distributor</td>
                    <td>@Model.Order.DistributorName</td>
                </tr>
                <tr>
                    <td class="fw-bold">Distributor Confirmed on</td>
                    <td>@(Model.Order.ConfirmedOn.HasValue? Model.Order.ConfirmedOn.Value.ToString("dd MMM yyyy hh:mm tt") : "-")</td>
                </tr>
            </tbody>
        </table>

        <p class="order-status">
            <strong>Status:</strong>
            @if (Model.Order.OrderStatus == GadgetHub.Dtos.Enums.OrderStatus.Completed)
            {
                <span class="text-success fw-bold">@Model.Order.OrderStatus</span>
            }
            else
            {
                <span class="text-warning fw-bold">@Model.Order.OrderStatus</span>
            }
        </p>
    </div>

   <table class="table order-items-table">
    <thead>
        <tr>
            <th>Product</th>
            <th class="text-center">Qty</th>
           @*  <th class="text-end">Price</th>
            <th class="text-end">Total</th> *@
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model.Order.OrderItems)
        {
            <tr>
                <td>@item.ProductName</td>
                <td class="text-center">@item.Quantity</td>
                @* <td class="text-end">@item.Price</td>
                <td class="text-end">@item.Quantity * item.Price</td> *@
            </tr>
        }
    </tbody>
</table>


    @if (quotations != null && quotations.Any())
    {
        <div class="row">
            @foreach (var quotation in quotations)
            {
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm">
                        <!-- Card Header -->
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">@quotation.CompanyName</h5>
                            <small>Estimated Delivery: @(quotation.EstimatedDeliveryDateTime?.ToString("yyyy-MM-dd") ?? "N/A")</small>
                        </div>

                        <!-- Card Body -->
                        <div class="card-body">
                            <p><strong>Total Amount:</strong> @quotation.TotalAmount</p>

                            <!-- Wrap only this quotation in a form -->
                            <form method="post" asp-page-handler="ConfirmQuotation">
                                <input type="hidden" name="SelectedQuotationId" value="@quotation.Id" />
                                <input type="hidden" name="SelectedApiUrlId" value="@quotation.ApiUrl" />
                                <input type="hidden" name="SelectedDistributorName" value="@quotation.CompanyName" />
                                <input type="hidden" name="TotalAmount" value="@quotation.TotalAmount" />

                                @* Include line-level items as hidden inputs *@
                                @for (int i = 0; i < quotation.QuotationItems.Count; i++)
                                {
                                    var item = quotation.QuotationItems[i];
                                    <input type="hidden" name="QuotationItems[@i].ProductName" value="@item.ProductName" />
                                    <input type="hidden" name="QuotationItems[@i].Quantity" value="@item.Quantity" />
                                    <input type="hidden" name="QuotationItems[@i].Price" value="@item.Price" />
                                }
                                @if (!Model.Order.QuotationId.HasValue)
                                {
                                    <button type="submit" class="btn btn-sm btn-success">Confirm Order</button>
                                }
                            </form>

                            <!-- Display line-level items -->
                            <table class="table table-sm table-bordered mt-3">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in quotation.QuotationItems)
                                    {
                                        <tr>
                                            <td>@item.ProductName</td>
                                            <td>@item.Quantity</td>
                                            <td>@item.Price</td>
                                            <td>@(item.Quantity* item.Price)</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    @if (Model.Order.QuotationId.HasValue)
    {
        <h1 class="text-success text-center">This order is confirmed to @Model.Order.DistributorName !</h1>
    }

}
else
{
    <p>No order details available.</p>
}
